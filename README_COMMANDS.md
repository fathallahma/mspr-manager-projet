# üöÄ MSPR COFRAP SecureAuth - Guide d'Ex√©cution

## üìã Vue d'ensemble

Ce projet d√©ploie un syst√®me d'authentification serverless avec :
- **3 fonctions OpenFaaS** : `generate-password`, `generate-2fa`, `authenticate-user`
- **Cluster Kubernetes K3d** avec OpenFaaS
- **Base de donn√©es PostgreSQL** locale
- **Frontend React** avec proxy Nginx
- **Tests automatis√©s** et validation d'accessibilit√©

---

## üõ†Ô∏è Pr√©requis

### Installation des outils requis

```bash
# Docker
sudo apt update && sudo apt install docker.io
sudo usermod -aG docker $USER
newgrp docker

# k3d
curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash

# kubectl
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

# OpenFaaS CLI
curl -sL https://cli.openfaas.com | sudo sh

# Helm
curl https://baltocdn.com/helm/signing.asc | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/helm.gpg] https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
sudo apt update && sudo apt install helm

# PostgreSQL (client + serveur)
sudo apt install postgresql postgresql-client

# Node.js & npm
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install nodejs

# jq (pour les tests)
sudo apt install jq
```

---

## üóÑÔ∏è Configuration de la Base de Donn√©es

### 1. D√©marrer PostgreSQL

```bash
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### 2. Cr√©er la base de donn√©es

```bash
# Se connecter comme utilisateur postgres
sudo -u postgres psql

# Dans psql, ex√©cuter :
CREATE DATABASE mspr_db;
CREATE USER mspr_user WITH PASSWORD 'mspr_password123';
GRANT ALL PRIVILEGES ON DATABASE mspr_db TO mspr_user;
\q
```

### 3. Initialiser le sch√©ma

```bash
# Depuis le r√©pertoire du projet
psql -h localhost -U mspr_user -d mspr_db -f database/init.sql
```

### 4. Variables d'environnement

```bash
export DB_HOST=localhost
export DB_PORT=5432
export DB_NAME=mspr_db
export DB_USER=mspr_user
export DB_PASSWORD=mspr_password123
```

---

## ‚ò∏Ô∏è D√©ploiement Kubernetes + OpenFaaS

### 1. Cr√©er le cluster k3d

```bash
# Nettoyer les clusters existants
k3d cluster delete demo 2>/dev/null || true

# Cr√©er le nouveau cluster
k3d cluster create demo --wait

# V√©rifier le cluster
kubectl get nodes
```

### 2. Configurer l'acc√®s √† la base externe

```bash
# Patcher CoreDNS pour r√©soudre host.k3d.internal
kubectl get configmap coredns -n kube-system -o yaml | \
sed 's/ready$/&\nhost.k3d.internal 172.17.0.1/' | \
kubectl apply -f -

# Red√©marrer CoreDNS
kubectl -n kube-system rollout restart deploy/coredns
kubectl -n kube-system rollout status deploy/coredns --timeout=60s
```

### 3. Installer OpenFaaS

```bash
# Ajouter le repo Helm
helm repo add openfaas https://openfaas.github.io/faas-netes/
helm repo update

# Cr√©er les namespaces
kubectl apply -f https://raw.githubusercontent.com/openfaas/faas-netes/master/namespaces.yml

# Installer OpenFaaS
helm upgrade --install openfaas openfaas/openfaas \
  --namespace openfaas \
  --set functionNamespace=openfaas-fn \
  --set generateBasicAuth=true \
  --set directFunctions=true

# Attendre le d√©ploiement
kubectl wait --for=condition=available --timeout=300s deployment/gateway -n openfaas
```

### 4. Port-forward vers OpenFaaS

```bash
# Arr√™ter les port-forwards existants
pkill -f "kubectl port-forward.*8088" || true

# D√©marrer le port-forward
kubectl port-forward -n openfaas svc/gateway 8088:8080 > kubectl_pf.log 2>&1 &

# V√©rifier la connexion
sleep 5
curl -s -f http://127.0.0.1:8088/healthz
```

---

## üîê D√©ploiement des Secrets et Fonctions

### 1. Appliquer les Sealed Secrets

```bash
# Installer Sealed Secrets Controller
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.18.0/controller.yaml

# Appliquer vos secrets chiffr√©s
kubectl apply -f sealed-db-creds.yaml
kubectl apply -f sealed-mfa-key.yaml

# V√©rifier les secrets
kubectl get secrets -n openfaas-fn
```

### 2. Se connecter √† OpenFaaS

```bash
# R√©cup√©rer le mot de passe admin
PASSWORD=$(kubectl get secret -n openfaas basic-auth -o jsonpath="{.data.basic-auth-password}" | base64 --decode)

# Se connecter
echo $PASSWORD | faas-cli login --username admin --password-stdin --gateway http://127.0.0.1:8088
```

### 3. D√©ployer les fonctions

```bash
# D√©ployer toutes les fonctions
faas-cli deploy -f stack.yaml --gateway http://127.0.0.1:8088

# V√©rifier le d√©ploiement
faas-cli list --gateway http://127.0.0.1:8088

# Attendre que toutes les fonctions soient pr√™tes
while [ $(faas-cli list --gateway http://127.0.0.1:8088 | grep -c "Ready") -lt 3 ]; do
  echo "Attente du d√©ploiement des fonctions..."
  sleep 5
done
```

---

## üåê D√©marrage du Proxy Nginx

```bash
# Arr√™ter le conteneur existant
docker stop nginx-cors-proxy 2>/dev/null || true
docker rm nginx-cors-proxy 2>/dev/null || true

# D√©marrer le proxy CORS
docker run -d \
  --name nginx-cors-proxy \
  --network host \
  -v $(pwd)/nginx-cors-proxy.conf:/etc/nginx/nginx.conf:ro \
  nginx:alpine

# V√©rifier le proxy
curl -s http://localhost:8089/healthz
```

---

## ‚öõÔ∏è D√©marrage du Frontend React

### 1. Installation des d√©pendances

```bash
cd front
npm install
```

### 2. Configuration de l'environnement

```bash
# Cr√©er le fichier .env.local
echo "REACT_APP_OPENFAAS_GATEWAY=http://localhost:8089" > .env.local
```

### 3. D√©marrer l'application

```bash
# Forcer le port 3001
export PORT=3001

# D√©marrer React
npm start > ../react_server.log 2>&1 &

# Attendre que React soit pr√™t
sleep 10
curl -s http://localhost:3001
```

---

## üß™ Tests et Validation

### 1. Tests de base de donn√©es

```bash
# Tester la connexion PostgreSQL
psql -h $DB_HOST -U $DB_USER -d $DB_NAME -c "SELECT COUNT(*) FROM users;"
```

### 2. Tests des fonctions serverless

```bash
# Test generate-password
curl -X POST http://localhost:8089/function/generate-password \
  -H "Content-Type: application/json" \
  -d '{"username": "test_user"}' | jq

# Test generate-2fa
curl -X POST http://localhost:8089/function/generate-2fa \
  -H "Content-Type: application/json" \
  -d '{"username": "test_user"}' | jq

# Test authenticate-user
curl -X POST http://localhost:8089/function/authenticate-user \
  -H "Content-Type: application/json" \
  -d '{"username": "test_user", "password": "your_generated_password"}' | jq
```

### 3. Tests d'accessibilit√© frontend

```bash
cd front

# Tests d'accessibilit√©
npm test -- --testMatch="**/*.a11y.test.js" --watchAll=false

# Tests unitaires
npm test -- --watchAll=false

# Tests de couverture
npm test -- --coverage --watchAll=false
```

### 4. Tests d'int√©gration complets

```bash
# Depuis la racine du projet
python3 test_scenarios.py
python3 test_complete_scenarios.py
```

---

## üìä Monitoring et Logs

### 1. V√©rifier l'√©tat du cluster

```bash
# Pods OpenFaaS
kubectl get pods -n openfaas

# Fonctions d√©ploy√©es
kubectl get pods -n openfaas-fn

# Services
kubectl get svc -n openfaas
```

### 2. Consulter les logs

```bash
# Logs des fonctions
kubectl logs -f deployment/generate-password -n openfaas-fn
kubectl logs -f deployment/generate-2fa -n openfaas-fn
kubectl logs -f deployment/authenticate-user -n openfaas-fn

# Logs du gateway OpenFaaS
kubectl logs -f deployment/gateway -n openfaas

# Logs du proxy Nginx
docker logs -f nginx-cors-proxy

# Logs du frontend React
tail -f react_server.log
```

### 3. M√©triques Prometheus

```bash
# Port-forward vers Prometheus
kubectl port-forward -n openfaas svc/prometheus 9090:9090 &

# Ouvrir dans le navigateur
xdg-open http://localhost:9090
```

---

## üöÄ Script de D√©marrage Automatique

### Utiliser le script fourni

```bash
# Rendre le script ex√©cutable
chmod +x start_full_demo.sh

# Lancer la d√©mo compl√®te
./start_full_demo.sh
```

Ce script automatise toutes les √©tapes ci-dessus.

---

## üßπ Arr√™t et Nettoyage

### 1. Arr√™ter les services

```bash
# Arr√™ter React
pkill -f "npm start" || true

# Arr√™ter le proxy Nginx
docker stop nginx-cors-proxy
docker rm nginx-cors-proxy

# Arr√™ter les port-forwards
pkill -f "kubectl port-forward" || true
```

### 2. Nettoyer le cluster

```bash
# Supprimer le cluster k3d
k3d cluster delete demo

# Nettoyer les images Docker (optionnel)
docker system prune -f
```

### 3. Arr√™ter PostgreSQL (optionnel)

```bash
sudo systemctl stop postgresql
```

---

## üåç URLs d'Acc√®s

Une fois tout d√©marr√©, voici les URLs importantes :

- **Frontend React** : http://localhost:3001
- **Proxy Nginx** : http://localhost:8089
- **OpenFaaS Gateway** : http://localhost:8088
- **Prometheus** : http://localhost:9090 (apr√®s port-forward)

---

## üîß D√©pannage

### Probl√®mes courants

1. **Port d√©j√† utilis√©** :
   ```bash
   sudo lsof -i :3001  # V√©rifier qui utilise le port
   pkill -f "port_process"  # Tuer le processus
   ```

2. **Cluster k3d ne d√©marre pas** :
   ```bash
   k3d cluster delete demo
   docker system prune -f
   k3d cluster create demo --wait
   ```

3. **Base de donn√©es inaccessible** :
   ```bash
   sudo systemctl status postgresql
   sudo systemctl restart postgresql
   ```

4. **Fonctions non d√©ploy√©es** :
   ```bash
   faas-cli remove -f stack.yaml
   faas-cli deploy -f stack.yaml
   ```

---

## üìö Documentation Technique

- **Architecture** : voir `ARCHITECTURE_EXPLAINED.md`
- **Fonctions** : voir `FUNCTIONS_README.md`  
- **Tests** : voir `TESTS_DOCUMENTATION.md`
- **Frontend** : voir `front/README.md`

---

## üéØ Validation Finale

Pour v√©rifier que tout fonctionne :

1. ‚úÖ Frontend accessible sur http://localhost:3001
2. ‚úÖ Cr√©ation d'un compte via l'interface
3. ‚úÖ G√©n√©ration de mot de passe + QR code
4. ‚úÖ Activation 2FA + QR code TOTP
5. ‚úÖ Connexion avec mot de passe + code 2FA
6. ‚úÖ Tests d'accessibilit√© passent
7. ‚úÖ M√©triques Prometheus disponibles

**üéâ Si toutes ces √©tapes passent, votre d√©mo MSPR est pr√™te !** 